#!/bin/bash
######################################
proj=omrv
#173gg
inimodel=ini_model.mrc
sf=omrv_sf.sm
cpu=32
#################
apix=1.09
apixbin2=2.18
apixbin4=4.36
#################
mask=240
#200 boxsize400
maskbin2=120
#100
maskbin4=60
#50
#################
masknorm=240
#200
masknorm2=288
#240
masknormbin2=120
#100
masknormbin4=60
#50
#################
maskjalign1=60
#50
maskjalign2=54
#46
maskjalign4=110
#90
maskjalign5=220
#180
######################################

jspr.py ${proj}.shrink-4.lst --initModels ${inimodel} --iters 3 --iter0 0 --eotest 1 --cpus ${cpu} --sym icos --batchSize 50 --apix ${apixbin4} --phaseCorrected 0 --mask ${maskbin4} --aligner jalign --alignerOption="--oversample 3 --batchsize 1 --superaligner gridSearchOrientationCenter:discardMap=1:maskradius=${maskjalign1}:masksoft=-3 --sym=icos --orientgen eman:delta=3:inc_mirror=0:perturb=1 --aligner  pft:flip=1:precision=0.1:rmax=55:rmin=2:stepxy=1 --preprocess filter.ctf:type=1:oversample=3 --preprocess filter.sharpening:bfactor=-100:cutoffres=10:steep=20 --preprocess normalize.mask.circlemean:mask=0:radius=${masknormbin4} --projector standard --cmp ccc" --iterFilter 1 --imageListFilter "--sortby score:keeptype=sigma:min=-100:max=1" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apixbin4} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=4 --process filter.sharpening:bfactor=0:cutoffres=9:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3 --process mask.inner:radius=15:masksoft=-3" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar >result1.log

# refine euler/center to higher accuracy 
jspr.py ${proj}.shrink-4.lst --rawupdate 1 --iters 5 --iter0 0 --eotest 1 --cpus ${cpu} --sym icos --batchSize 50 --apix ${apixbin4} --phaseCorrected 0 --mask ${maskbin4} --aligner jalign --alignerOption="--oversample 3 --batchsize 1 --aligner refineOrientationCenter2:flipphase=0:maskradius=${maskjalign2}:masksoft=-3:rangerot=180:rangexy=3 --preprocess filter.ctf:type=1:oversample=3 --preprocess normalize.mask.circlemean:mask=0:radius=${masknormbin4} --projector fourierGriddingRSTM:npad=1 --cmp ccc" --iterFilter 1 --imageListFilter "--sortby score:keeptype=sigma:min=-100:max=1" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apixbin4} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=4 --process filter.sharpening:bfactor=0:cutoffres=9:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3 --process mask.inner:radius=20:masksoft=-3" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result2.log

# further refine the consistent (median) euler/center parameters 
jspr.py orientation-center.5.lst --initEuler default --rawupdate 1 --iters 12 --iter0 10 --eotest 1 --cpus ${cpu} --sym icos --batchSize 50 --apix ${apixbin4} --phaseCorrected 0 --mask ${maskbin4} --aligner jalign --alignerOption="--oversample 3 --batchsize 1 --aligner refineOrientationCenter:flipphase=0:maskradius=${maskjalign2}:masksoft=-3:steprot=1:stepxy=1 --preprocess filter.ctf:type=1:oversample=3 --preprocess normalize.mask.circlemean:mask=0:radius=${masknormbin4} --projector fourierGriddingRSTM:npad=1 --cmp ccc" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apixbin4} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=4 --process filter.sharpening:bfactor=0:cutoffres=9:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknormbin4}:masksoft=-3 --process mask.inner:radius=20:masksoft=-3" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --post3dParallel runpar --verbose 2 >result3.log






images2lst.py orientation-center.12.lst ${proj}.shrink-2.lst --multCenter 2 --replace "shrink-4" "shrink-2" --keepParm euler center

# further refine euler/center parameters
jspr.py ${proj}.shrink-2.lst --initEuler default --rawupdate 1 --iters 22 --iter0 20 --eotest 1 --cpus ${cpu} --sym icos --batchSize 50 --apix ${apixbin2} --phaseCorrected 0 --mask ${maskbin2} --aligner jalign --alignerOption="--oversample 3 --batchsize 1 --aligner refineOrientationCenter:flipphase=0:maskradius=${maskjalign4}:masksoft=-3:steprot=1:stepxy=1 --preprocess filter.ctf:type=1:oversample=3 --preprocess normalize.mask.circlemean:mask=0:radius=${masknormbin2} --projector fourierGriddingRSTM:npad=1 --cmp ccc" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apixbin2} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=4 --process filter.sharpening:bfactor=0:cutoffres=4.2:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3 --process mask.inner:radius=40:masksoft=-3" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result4.log

# refine defocus
#jspr.py ${proj}.shrink-2.lst --initEuler default --rawupdate 1 --iters 24 --iter0 20 --eotest 3 --cpus ${cpu} --sym icos --batchSize 50 --apix ${apixbin2} --phaseCorrected 0 --mask ${maskbin2} --aligner jalign --alignerOption="--oversample 3 --batchsize -1 --aligner  refineMicrographDefocus:batchsize=-1:ctfonproj=0:defocusrange=0.2:discardMap=0:maskradius=${maskjalign4}:masksoft=-3:precision=0.005:stepdefocus=0.02:useOrigDefocus=1 --aligner refineOrientationCenter:flipphase=1:maskradius=${maskjalign4}:masksoft=-3:steprot=1:stepxy=1 --preprocess normalize.mask.circlemean:mask=0:radius=${masknormbin2} --projector fourierGriddingRSTM:npad=1 --cmp ccc" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apixbin2} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=4 --process filter.sharpening:bfactor=0:cutoffres=4.2:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3 --process mask.inner:radius=40:masksoft=-3" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result5.log

# refine astigmatism
jspr.py ${proj}.shrink-2.lst --initEuler default --rawupdate 1 --iters 26 --iter0 20 --eotest 3 --cpus ${cpu} --sym icos --batchSize 50 --apix ${apixbin2} --phaseCorrected 0 --mask ${maskbin2} --aligner jalign --alignerOption "--oversample 3 --batchsize -1 --aligner  refineMicrographDefocus:batchsize=-1:ctfonproj=0:defocusrange=0.2:discardMap=0:maskradius=${maskjalign4}:masksoft=-3:precision=0.005:stepdefocus=0.02:useOrigDefocus=1 --aligner refineAstigmatism:batchsize=-1:ctfonproj=0:dfdiffrange=0.2:discardMap=0:maskradius=${maskjalign4}:masksoft=-3:precision=0.005:stepdfdiff=0.02 --aligner refineOrientationCenter:flipphase=1:maskradius=${maskjalign4}:masksoft=-3:steprot=1:stepxy=1 --preprocess normalize.mask.circlemean:mask=0:radius=${masknormbin2} --projector fourierGriddingRSTM:npad=1 --cmp ccc" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apixbin2} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=4 --process filter.sharpening:bfactor=0:cutoffres=4.2:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3 --process mask.inner:radius=40:masksoft=-3" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result6.log

# refine scale
jspr.py ${proj}.shrink-2.lst --initEuler default --rawupdate 1 --iters 27 --iter0 20 --eotest 1 --cpus ${cpu} --sym icos --batchSize 50 --apix ${apixbin2} --phaseCorrected 0 --mask ${maskbin2} --aligner jalign --alignerOption "--oversample 3 --batchsize -1 --aligner refineScale:batchsize=-1:ctfonproj=0:flipphase=1:maskradius=${maskjalign4}:masksoft=-3:precision=0.002:scalerange=0.02:stepscale=0.002 --aligner refineOrientationCenter:flipphase=1:maskradius=${maskjalign4}:masksoft=-3:steprot=1:stepxy=1 --preprocess normalize.mask.circlemean:mask=0:radius=${masknormbin2} --projector fourierGriddingRSTM:npad=1 --cmp ccc" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apixbin2} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=4 --process filter.sharpening:bfactor=0:cutoffres=4.2:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknormbin2}:masksoft=-3 --process mask.inner:radius=40:masksoft=-3" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result7.log






images2lst.py orientation-center.27.lst ${proj}.shrink-1.lst --multCenter 2 --replace ".shrink-2" "" --keepParm euler center dfdiff dfang defocus scale
# build 3D maps from shrink-2 euler/center parameters

jspr.py ${proj}.shrink-1.lst --initEuler default --rawupdate 1 --iters 32 --iter0 30 --eotest 1 --cpus ${cpu} --sym icos --batchSize 10 --apix ${apix} --phaseCorrected 0 --mask ${mask} --aligner jalign --alignerOption="--oversample 0 --batchsize 1 --aligner refineOrientationCenter:flipphase=0:maskradius=${maskjalign5}:masksoft=-5:steprot=1:stepxy=1 --preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess normalize.mask.circlemean:mask=0:radius=${masknorm}:usescale=1 --projector fourierGriddingRSTM:npad=1 --cmp ccc" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apix} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=16 --process filter.sharpening:bfactor=-36:cutoffres=2.15:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5 --process mask.inner:radius=120:masksoft=-5 --process mask.auto3d:nmaxseed=600:nshells=5:nshellsgauss=5:threshold=2" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result8.log

# change cmp from ccc to phaseResRange
jspr.py ${proj}.shrink-1.lst --initEuler default --rawupdate 1 --iters 33 --iter0 30 --eotest 1 --cpus ${cpu} --sym icos --batchSize 5 --apix ${apix} --phaseCorrected 0 --mask ${mask} --aligner jalign --alignerOption="--oversample 0 --batchsize 1 --aligner refineOrientationCenter:flipphase=0:maskradius=${maskjalign5}:masksoft=-5:steprot=1:stepxy=1 --preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess normalize.mask.circlemean:mask=0:radius=${masknorm}:usescale=1 --projector fourierGriddingRSTM:npad=1 --cmp phaseResRange:lowRes=150:lowRes2=5:highRes=5:ampweight=0:ctfampweight=1:mode=0:bfactor=0:weightFile=fsc.%liter.txt.fit" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apix} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=16 --process filter.sharpening:bfactor=-36:cutoffres=2.15:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknorm2}:masksoft=-5 --process mask.inner:radius=120:masksoft=-5 --process mask.auto3d:nmaxseed=600:nshells=5:nshellsgauss=5:threshold=2" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result9.log

# refine defocus (per particle), extend cmp highres to 3A
jspr.py ${proj}.shrink-1.lst --initEuler default --rawupdate 1 --iters 34 --iter0 30 --eotest 1 --cpus ${cpu} --sym icos --batchSize 5 --apix ${apix} --phaseCorrected 0 --mask ${mask} --aligner jalign --alignerOption="--oversample 0 --batchsize 1  --aligner  refineMicrographDefocus:batchsize=1:ctfonproj=0:defocusrange=0.2:discardMap=0:maskradius=${maskjalign5}:masksoft=-5:precision=0.005:stepdefocus=0.02:useOrigDefocus=1 --aligner refineOrientationCenter:flipphase=1:maskradius=${maskjalign5}:masksoft=-5:steprot=1:stepxy=1 --preprocess normalize.mask.circlemean:mask=0:radius=${masknorm}:usescale=1 --projector fourierGriddingRSTM:npad=1 --cmp phaseResRange:lowRes=150:lowRes2=3:highRes=3:ampweight=0:ctfampweight=1:mode=0:bfactor=0:weightFile=fsc.%liter.txt.fit" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apix} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=16 --process filter.sharpening:bfactor=-36:cutoffres=2.15:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknorm2}:masksoft=-5 --process mask.inner:radius=120:masksoft=-5 --process mask.auto3d:nmaxseed=600:nshells=5:nshellsgauss=5:threshold=2" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 > result10.log

# refine astigmatism (per particle)
jspr.py ${proj}.shrink-1.lst --initEuler default --rawupdate 1 --iters 35 --iter0 30 --eotest 1 --cpus ${cpu} --sym icos --batchSize 5 --apix ${apix} --phaseCorrected 0 --mask ${mask} --aligner jalign --alignerOption="--oversample 0 --batchsize 1  --aligner refineAstigmatism:batchsize=-1:ctfonproj=0:dfdiffrange=0.1:discardMap=0:maskradius=${maskjalign5}:masksoft=-5:precision=0.001:stepdfdiff=0.02 --aligner  refineMicrographDefocus:batchsize=1:ctfonproj=0:defocusrange=0.05:discardMap=0:maskradius=${maskjalign5}:masksoft=-5:precision=0.001:stepdefocus=0.02:useOrigDefocus=1 --aligner refineOrientationCenter:flipphase=1:maskradius=${maskjalign5}:masksoft=-5:steprot=1:stepxy=1 --preprocess normalize.mask.circlemean:mask=0:radius=${masknorm}:usescale=1 --projector fourierGriddingRSTM:npad=1 --cmp phaseResRange:lowRes=150:lowRes2=3:highRes=3:ampweight=0:ctfampweight=1:mode=0:bfactor=0:weightFile=fsc.%liter.txt.fit" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apix} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=16 --process filter.sharpening:bfactor=-36:cutoffres=2.15:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknorm2}:masksoft=-5 --process mask.inner:radius=120:masksoft=-5 --process mask.auto3d:nmaxseed=600:nshells=5:nshellsgauss=5:threshold=2" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result11.log

# refine mag (per particle)
jspr.py ${proj}.shrink-1.lst --initEuler default --rawupdate 1 --iters 36 --iter0 30 --eotest 1 --cpus ${cpu} --sym icos --batchSize 5 --apix ${apix} --phaseCorrected 0 --mask ${mask} --aligner jalign --alignerOption="--oversample 0 --batchsize -1 --aligner refineScale:batchsize=1:ctfonproj=0:flipphase=1:maskradius=${maskjalign5}:masksoft=-5:precision=0.001:scalerange=0.02:stepscale=0.004 --aligner refineAstigmatism:batchsize=1:ctfonproj=0:dfdiffrange=0.05:discardMap=0:maskradius=${maskjalign5}:masksoft=-5:precision=0.001:stepdfdiff=0.01 --aligner  refineMicrographDefocus:batchsize=1:ctfonproj=0:defocusrange=0.05:discardMap=0:maskradius=${maskjalign5}:masksoft=-5:precision=0.001:stepdefocus=0.01:useOrigDefocus=0 --aligner refineOrientationCenter:flipphase=1:maskradius=${maskjalign5}:masksoft=-5:steprot=0.5:stepxy=0.5 --preprocess normalize.mask.circlemean:mask=0:radius=${masknorm}:usescale=1 --projector fourierGriddingRSTM:npad=1 --cmp phaseResRange:lowRes=150:lowRes2=3:highRes=3:ampweight=0:ctfampweight=1:mode=0:bfactor=0:weightFile=fsc.%liter.txt.fit" --iterFilter 1 --imageListFilter "" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=${masknorm}:masksoft=-5:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=${masknorm2}:masksoft=-5 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes ${cpu} --make3dppn -1 --post3dOption "--cpu ${cpu} --apix ${apix} --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=${sf}:smooth=16 --process filter.sharpening:bfactor=-36:cutoffres=2.15:steep=20 --process normalize.mask.circlemean:mask=1:radius=${masknorm2}:masksoft=-5 --process mask.inner:radius=120:masksoft=-5 --process mask.auto3d:nmaxseed=600:nshells=5:nshellsgauss=5:threshold=2" --make3dParallel mpi --make3dMPI openmpi --parallelMethod runpar --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result12.log

#jspr.py ${proj}.shrink-1.lst --initEuler default --rawupdate 1 --iters 37 --iter0 30 --skip2dalign 1 --eotest 3 --cpus 8 --sym icos --batchSize 5 --apix 1.09 --phaseCorrected 0 --mask 240 --aligner jalign --alignerOption="--oversample 0 --batchsize -1 --aligner refineScale:batchsize=1:ctfonproj=0:flipphase=1:maskradius=240:masksoft=-5:precision=0.001:scalerange=0.02:stepscale=0.004 --aligner refineAstigmatism:batchsize=1:ctfonproj=0:dfdiffrange=0.05:discardMap=0:maskradius=240:masksoft=-5:precision=0.001:stepdfdiff=0.01 --aligner  refineMicrographDefocus:batchsize=1:ctfonproj=0:defocusrange=0.05:discardMap=0:maskradius=240:masksoft=-5:precision=0.001:stepdefocus=0.01:useOrigDefocus=0 --aligner refineOrientationCenter:flipphase=1:maskradius=240:masksoft=-5:steprot=0.5:stepxy=0.5 --preprocess normalize.mask.circlemean:mask=0:radius=240:usescale=1 --projector fourierGriddingRSTM:npad=1 --cmp phaseResRange:lowRes=150:lowRes2=2.5:highRes=2.5:ampweight=0:ctfampweight=1:mode=0:bfactor=0:weightFile=fsc.%liter.set-0-1.txt.fit" --iterFilter 1 --imageListFilter "--sortby score:keeptype=ratio:min=0:max=0.5" --reconstructor j3dr --j3drForwarded "--preprocess filter.ctf:type=1:oversample=0 --preprocess filter.ctf:type=8:oversample=0 --preprocess xform.centerbyxform --preprocess normalize.mask.circlemean:mask=1:radius=240:masksoft=-5:usescale=1 --postprocess normalize.mask.circlemean:mask=1:radius=240:masksoft=-5 --reconstructor fourier:mode=gauss_2:ctfweight=1" --make3dNodes 8 --make3dppn -1 --post3dOption "--cpu 8 --apix 1.09 --process xform.symmetrize:sym=icos --process filter.setstrucfac:sffile=omrv_sf.sm:smooth=16 --process filter.sharpening:bfactor=-36:cutoffres=2.5:steep=20 --process normalize.mask.circlemean:mask=1:radius=240:masksoft=-5 --process mask.inner:radius=120:masksoft=-5 --process mask.auto3d:nmaxseed=600:nshells=5:nshellsgauss=5:threshold=2" --make3dParallel mpi --make3dMPI openmpi --condorRemote 0 --condorRemoteWithBittorrent 0 --post3dParallel runpar --condorMaxIdle 4000 --condorMaxTrials 7 --verbose 2 >result13.log

